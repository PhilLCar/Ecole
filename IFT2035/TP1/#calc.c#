#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct Digits {
  int digit;
  struct Digits *next;
} digits;

typedef struct {
  int flags;
  digits *value;
} bigint;

void **stack_ptr;
int    stack_len = 0;
int    stack_cap = 1;

void parsenumber(int c);
void parseoperator(int c);
void parsevariable();
void checkstack();
void add();
void print();

void alert(char* message)
{
  printf(message);
  exit(1);
}

void stack(void *elem)
{
  void **tmp;
  stack_len++;
  if (stack_len > stack_cap) {
    stack_cap = stack_len;
    tmp = realloc(stack_ptr, stack_cap * sizeof(bigint*));
    if (tmp = NULL) alert("STACK FAIL");
    stack_ptr = tmp;
  }
  *(stack_ptr + stack_len - 1) = elem;
}

void checkstack()
{
}

void add()
{
  digits a = *(stack_ptr + stack_len - 1).value;
  digits b = *(stack_ptr + stack_len - 2).value;
  int res, carry = 0;
  while (a.next != NULL && b.next != NULL) {
    res = a.digit + b.digit + carry;
    carry = res > 9; // pour add seulement
    b.digit = res % 10;
  }
  if (a.next != NULL) {
    
  } else if (b.next != NULL) {

  } else {

  }
}

void parse()
{
  int c;
  while ((c = getchar()) != '\n') {
    if (c >= '0' && c <= '9')
      parsenumber(c);
    else if (c == '*' || c == '+' || c == '-' || c == '/')
      parseoperator(c);
    else if (c == '=')
      parsevariable();
    else if (c == ' ' || c == '\t')
      continue;
  }
}

void parsenumber(int c)
{
  bigint *big = malloc(sizeof(bigint));
  digits *dig = malloc(sizeof(digits)), *tmp;
  if (big == NULL || dig == NULL)
    alert("Memory error!");
  big->flags = 0;
  dig->digit = c & 0x0F;
  dig->next  = NULL;
  while ((c = getchar()) >= '0' && c <= '9') {
    tmp = dig;
    dig = malloc(sizeof(digits));
    if (dig == NULL)
      alert("ULTIMATE FAIL");
    dig->digit = c & 0x0F;
    dig->next = tmp;
  }
  stack(big);
}

void parseoperator(int c)
{
  switch(c) {
  case '+':
    add();
    break;
  case '-':
    //sub();
    break;
  case '*':
    //mul();
    break;
  case '/':
    //div();
    break;
  }
}

void parsevariable()
{
}

digits *newdigit(int digit) {
  digits *tmp = malloc(sizeof(digits));
  if (tmp == NULL)
    alert("MEMERROR");
  else {
    tmp->digit = digit;
    tmp->next = NULL;
  }
  return tmp;
}

void nextdigit(digits *old, int digit) {
  if (old->next == NULL)
    old->next = newdigit(digit);
  else {
    deldigits(old->next);
    old->next = newdigit(digit);
  }
}

void deldigits(digits *del) {
  digits *tmp;
  do {
    tmp = del->next;
    free(del);
    del = tmp;
  } while (del != NULL);
}

void newbigint() {
  bigint *tmp = malloc(sizeof(bigint));
  /// FAIRE newbigint ET RÉÉCRIRE parsenumber
}

void delbigint(bigint b) {
  
}

int main()
{
  stack_ptr = malloc(sizeof(bigint*));
  while(1) {
    printf("> ");
    parse();
  }
  return 0;
}

